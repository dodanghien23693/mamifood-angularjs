<!-- Page Content -->
<div class="content">
    <!-- Dynamic Table Full -->
    <div class="block">
        <div class="block-header">
            <h3 class="block-title">Quản lý danh mục sản phẩm</h3>
        </div>

        <div class="block-content" >
            <div id="tree"></div>
        </div>
    </div>
    <!-- END Dynamic Table Full -->

</div>
<!-- END Page Content -->

<link href="/assets/js/plugins/jstree/dist/themes/default/style.min.css" rel="stylesheet" />
<script src="/assets/js/plugins/jstree/dist/jstree.min.js"></script>
<script>
    function CreateTreeView(data) {
        TreeView = $('#tree')
        .jstree({
            'core': {
                
                'data': function (node, cb) {
                    //return { 'id': node.id };
                    if (node.id === "#") {
                        //debugger;
                        cb(data);
                    }
                    else {
                        alert("show folder");
                    }
                },
              
                'check_callback': function (o, n, p, i, m) {

                    if (m && m.dnd && m.pos !== 'i') { return false; }
                    if (o === "copy_node") {
                        this.get_node(n).text = "Bản sao " + this.get_node(n).text;
                    }
                    if (o === "move_node" || o === "copy_node") {
                        if (this.get_node(n).parent === this.get_node(p).id) { return false; }
                    }

                    return true;
                },
                'themes': {
                    'responsive': false,
                    'variant': 'small',
                    'stripes': true
                }
            },
            'sort': function (a, b) {
                return this.get_type(a) === this.get_type(b) ? (this.get_text(a) > this.get_text(b) ? 1 : -1) : (this.get_type(a) >= this.get_type(b) ? 1 : -1);
            },
            'contextmenu': {
                'items': function (node) {
                    var tmp = $.jstree.defaults.contextmenu.items();

                    delete tmp.create.action;
                    tmp.rename.label = "Đổi tên";
                    tmp.remove.label = "Xóa";
                    
                    tmp.ccp.label = "Thao tác";

                    tmp.create.label = "Tạo mới";
                    tmp.create.action = function(data){
                        var inst = $.jstree.reference(data.reference),
                                   obj = inst.get_node(data.reference);
                        swal("", "Thực hiện tạo mới nhóm sản phẩm", "info");
                    }

                    //tmp.create.submenu = {
                    //    "create_folder": {
                    //        "separator_after": true,
                    //        "label": "Folder",
                    //        "action": function (data) {
                    //            var inst = $.jstree.reference(data.reference),
                    //                obj = inst.get_node(data.reference);

                    //        }
                    //    },
                    //    "create_file": {
                    //        "label": "File",
                    //        "action": function (data) {
                    //            var inst = $.jstree.reference(data.reference),
                    //                obj = inst.get_node(data.reference);
                    //            inst.create_node(obj, { type: "file" }, "last", function (new_node) {
                    //                setTimeout(function () { inst.edit(new_node); }, 0);
                    //            });
                    //        }
                    //    }
                    //};
                    if (this.get_type(node) === "file") {
                        delete tmp.create;
                        tmp.CopyToRoot = {
                            label: "Copy to Root",
                            action: function (data) {

                                var node = $.jstree.reference(data.reference).get_node(data.reference);

                            }
                        }
                    }

                    return tmp;
                }
            },
            'types': {
                'default': { 'icon': 'folder' },
                'file': { 'valid_children': [], 'icon': 'file' }
            },
            'unique': {
                'duplicate': function (name, counter) {
                    return name + ' ' + counter;
                }
            },
            'plugins': ['dnd', 'sort', 'types', 'contextmenu', 'unique', 'wholerow']

        })
        .on('delete_node.jstree', function (e, data) {
            swal("", "Thực hiện xóa danh mục", "info");
        })
        .on('create_node.jstree', function (e, data) {
            $.get('?operation=create_node', { 'type': data.node.type, 'id': data.node.parent, 'text': data.node.text })
                .done(function (d) {
                    data.instance.set_id(data.node, d.id);
                })
                .fail(function () {
                    data.instance.refresh();
                });
        })
        .on('rename_node.jstree', function (e, data) {
            swal("", "Thực hiện đổi tên", "info");
        })
        .on('move_node.jstree', function (e, data) {

        })
        .on('copy_node.jstree', function (e, data) {


        })
        .on('paste.jstree', function (e, data) {

            if (data.mode == "copy_node") {
                // CopyFile(data.node[0], data.parent);     
                swal("", "Thực hiện sao chép danh mục", "info");
            }

            if (data.mode == "move_node") {
                swal("", "Thực hiện di chuyển danh mục", "info");
            }
        })
        .on('select_node.jstree', function (e, data) {
            //console.log("Select file: " + data.node);
            var id = data.node.id;
            var info = "";
            info += "path: ";
            for (var i = data.node.parents.length - 2; i >= 0; i--) {
                info += $("#" + data.node.parents[i] + "_anchor").text() + "/";
            }
            info += data.node.text + "</br>";

        })
        .on('changed.jstree', function (e, data) {

        });
    }
    $(document).ready(function () {
        
        $.getJSON("/jsons/danh-muc-san-pham.json", function (data) {
            CreateTreeView(data);
        });
    });
</script>